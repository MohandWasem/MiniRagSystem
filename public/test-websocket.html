<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini RAG System - WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .container { border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        input, button { padding: 10px; margin: 5px 0; width: 100%; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; background: #f9f9f9; }
        .message { margin: 5px 0; padding: 5px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mini RAG System - WebSocket Test</h1>
        
        <h3>Step 1: Login</h3>
        <input type="email" id="email" placeholder="Email" value="test@example.com">
        <input type="password" id="password" placeholder="Password" value="password123">
        <button onclick="login()">Login</button>
        
        <h3>Step 2: Connect to WebSocket</h3>
        <button onclick="connectWebSocket()" id="connectBtn" disabled>Connect WebSocket</button>
        <p id="status">Status: Not connected</p>
        
        <h3>Step 3: Send Query</h3>
        <input type="text" id="query" placeholder="Your question" value="What is this document about?">
        <input type="number" id="pdfId" placeholder="PDF ID (optional)" value="1">
        <button onclick="sendQuery()" id="queryBtn" disabled>Send Query</button>
        
        <h3>Messages:</h3>
        <div id="messages"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1.16.1/dist/echo.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pusher-js@8.4.0-rc2/dist/web/pusher.min.js"></script>

    <script>
        let token = null;
        let userId = null;
        let echo = null;

        function addMessage(msg, className = '') {
            const div = document.createElement('div');
            div.className = 'message ' + className;
            div.textContent = msg;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('http://127.0.0.1:8000/api/v1/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                console.log('Login response:', data);
                
                if (data.key === 'success' && data.data) {
                    token = data.data.token;
                    userId = data.data.id;
                    addMessage('‚úÖ Login successful! User ID: ' + userId, 'success');
                    addMessage('Token: ' + token.substring(0, 30) + '...', 'success');
                    document.getElementById('connectBtn').disabled = false;
                } else {
                    addMessage('‚ùå Login failed: ' + (data.msg || 'Unknown error'), 'error');
                }
            } catch (error) {
                addMessage('‚ùå Error: ' + error.message, 'error');
            }
        }

        function connectWebSocket() {
            if (!token) {
                addMessage('‚ùå Please login first', 'error');
                return;
            }

            echo = new Echo({
                broadcaster: 'pusher',
                key: '76810d55acf60378b184',
                cluster: 'eu',
                encrypted: true,
                authEndpoint: 'http://127.0.0.1:8000/broadcasting/auth',
                auth: {
                    headers: {
                        Authorization: 'Bearer ' + token,
                    }
                }
            });

            echo.private(`chat.${userId}`)
                .listen('.chat.stream', (e) => {
                    if (e.error) {
                        addMessage('‚ùå Error: ' + e.error, 'error');
                    } else if (e.done) {
                        addMessage('--- Stream ended ---', 'success');
                    } else {
                        addMessage('üì© ' + e.chunk);
                    }
                });

            document.getElementById('status').textContent = 'Status: Connected';
            document.getElementById('status').style.color = 'green';
            document.getElementById('queryBtn').disabled = false;
            addMessage('‚úÖ WebSocket connected to chat.' + userId, 'success');
        }

        async function sendQuery() {
            const query = document.getElementById('query').value;
            const pdfId = document.getElementById('pdfId').value;

            if (!query) {
                addMessage('‚ùå Please enter a query', 'error');
                return;
            }

            if (!token) {
                addMessage('‚ùå Please login first', 'error');
                return;
            }

            try {
                addMessage('üì§ Sending query: ' + query);
                addMessage('üîë Using token: ' + token.substring(0, 20) + '...');
                
                const response = await fetch('http://127.0.0.1:8000/api/v1/chat/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        query: query,
                        pdf_id: pdfId ? parseInt(pdfId) : null
                    })
                });

                console.log('Response status:', response.status);
                const text = await response.text();
                console.log('Response text:', text);

                try {
                    const data = JSON.parse(text);
                    if (data.key === 'success') {
                        addMessage('‚úÖ ' + data.msg, 'success');
                    } else {
                        addMessage('‚ùå ' + data.msg, 'error');
                    }
                } catch (e) {
                    addMessage('‚ùå Invalid JSON response: ' + text.substring(0, 200), 'error');
                }
            } catch (error) {
                addMessage('‚ùå Error: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
